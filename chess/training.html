<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="index-files/style.css">
	<link rel="icon" type="image/x-icon" href="index-files/favicon.ico">
	<script defer src="index-files/script.js"></script>
	<title>index</title>
</head>
	
<body><main><h1>Index</h1>

<dialog id="setup">
<p>This page has no setups. Setup a <a href="?setup=♖♘♗♔♕♗♘♖♙♙♙♙♙♙♙♙////♟♟♟♟♟♟♟♟♜♞♝♚♛♝♞♜">standard game</a> or look for more setups at the <a href="index.html#setups">setups page</a>.
</p>
</dialog>

<script>
//https://www.w3docs.com/snippets/javascript/how-to-get-url-parameters.html
//https://stackoverflow.com/questions/3065342/how-do-i-iterate-through-table-rows-and-cells-in-javascript

window.onload = function(event) {
	const urlParams = new URLSearchParams(window.location.search);
	const move = urlParams.get('move')
	const player_name = localStorage.getItem('player-name')
	const drag = urlParams.get("draggable")
	
	document.getElementById("player2").textContent = urlParams.get('opponent')
	if (urlParams.has("setup")) {
		setup(urlParams.get('setup'))
	} else if (urlParams.has("opponent") && localStorage.getItem("side")) {
		const side = localStorage.getItem("side")
		setup(localStorage.getItem( urlParams.get('opponent') ), side)	
	}	else {
			//document.getElementById("setup").showModal()
			// standard setup + fill in opponent-name
			setup("rnbkqbnrpppppppp8888PPPPPPPPRNBKQBNR")
		}
}


document.ondragstart = function(event) {
	event.dataTransfer.setData("cell", event.target.id)
}

document.ondrop = function(event){
	event.preventDefault()
	from = event.dataTransfer.getData("cell")
	var cell = document.getElementById( from )
	
	if	( validate_move(cell.innerHTML, from, event.target.id) ) return
	
	event.target.innerHTML = cell.innerHTML
	event.target.draggable = true
	cell.innerHTML = ""
	cell.draggable = false
	
}

document.ondragover = function(event){
	event.preventDefault()
}

function reverseSetup(){
	var setup = []
	const cells = document.getElementsByTagName("td") 
	for (let i = 0; i < 64;i++) {
		var cell_value = cells[i].innerHTML;
		if (cell_value == "") {
			if (isNaN(setup.at(-1)) || setup.at(-1) == 8) {
				setup.push(1)
			} else {
				setup[setup.length -1] += 1
			}
		}
		else {
			setup.push(cell_value)
		}
	}
	document.getElementById("link").value = "https://boukew99.github.io/chess?setup=" + setup.reverse().join("");
	document.getElementById("link").display = "block";
	document.getElementById("link").select();
}

function char2piece(character) {
	switch (character) {
		case "k":	return "♚";
		case "K": return "♔";
		case "q": return "♛"
		case "Q": return "♕"
		case "b": return "♝"
		case "B": return "♗"
		case "n": return "♞"
		case "N": return "♘"
		case "r": return "♜"
		case "R": return "♖"
		case "p": return "♟"
		case "P": return "♙"
		default: return character
	}
}


function validate_move(piece, from, to) {
	switch (piece) {
		case "♜", "♖", "n", "N":
			break
		case "♟", "P":
		  alert("pawns can only move forward and capture diagonally.")
		  return true
		case "♙", "p":
			break
	}
}


function flip_fen(fen){
  return fen
}

function setup(fen2, side=false) {
		const setup =  fen2.split("");
		const cells = document.getElementsByTagName("td") 
		const select = document.getElementById("piece")
		const bench = "♖♘♗♔♕♗♘♖♙♙♙♙♙♙♙♙♟♟♟♟♟♟♟♟♜♞♝♚♛♝♞♜".split("")
		
			console.log(bench)
		for (let i = 0; i < 64;i=i) {
			var cell = cells[i];
			var character = setup.shift();
			if (!isNaN(character)) {
				i += parseInt(character);
			}	else if (character == "/"){
				if (i%8==0) {i=i}
				else { i += (8 - i % 8) }
			} else {				
			
				icon = char2piece(character)
				cell.innerHTML = (icon) ? icon : "";
				//cell.setAttribute("draggable", drag && cell.innerHTML != "" )
				if (icon) {bench.splice(bench.indexOf(icon), 1)}
				
				if (character == character.toLowerCase() == side) {
					
					var opt = document.createElement('option');
					opt.value = i;
					opt.innerHTML = String.fromCharCode(97 + 8 - Math.trunc((i/8+1))).toUpperCase() + (i%8 +1) + icon;
					select.appendChild(opt);
				}
				
				i++;
				}
			}
		document.getElementById("bench").innerHTML = bench.join("")
		const to = document.getElementById("to")
		for (let i = 1; i < 9;i+=1) {
			for (let j = 0; j < 8; j+=1) {
				const opt = document.createElement('option');
				opt.value = i;
				opt.innerHTML = String.fromCharCode(97 + j).toUpperCase() + i
				to.appendChild(opt)	
			}
		}
}
</script>
</main></body></html>
